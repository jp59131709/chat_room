<!DOCTYPE HTML>
<html xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </title>
    <script src="./js/jquery.min.js"></script>
    <script src="./js/canvi.js"></script>
    <script src="./js/layui.all.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/demo.css" />
    <link rel="stylesheet" type="text/css" href="./css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="./css/canvi.css" />
    <link rel="stylesheet" type="text/css" href="./css/login.css" />
    <link rel="stylesheet" type="text/css" href="./css/layui.css" />
    <!--the css for jquery.mCustomScrollbar-->
    <link rel="stylesheet" href="./css/jquery.mCustomScrollbar.min.css"/>
    <!--the css for this plugin-->
    <link rel="stylesheet" href="./css/jquery.emoji.css"/>
    <!--(Optional) the js for jquery.mCustomScrollbar's addon-->
    <script src="./js/jquery.mousewheel-3.0.6.min.js"></script>
    <!--the js for jquery.mCustomScrollbar-->
    <script src="./js/jquery.mCustomScrollbar.min.js"></script>
    <!--the js for this plugin-->
    <script src="./js/jquery.emoji.js"></script>
    <!--vue-->
    <script src="./js/vue.min.js"></script>
    <!--å¼•è¾¼å¤‰æ•°-->
    <script src="./js/common.variate.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/csshake.min.css">

</head>

<body onload="checkNotification()" style="background-color: rgb(230, 230, 230)">
    <aside id="aside" class="myCanvasNav canvi-navbar" data-position="left" data-push-content="false" style="width: 100vw;" inert="" aria-hidden="true">
        <div id="canvi" class="canvi-user-info" style="padding-top: 20px;padding-bottom: 20px;">
            <div class="canvi-user-info__data">
                <span id="activeRoom" class="canvi-user-info__title">ãƒ«ãƒ¼ãƒ ãƒŠãƒ³ãƒãƒ¼:</span>
                <a id="activeUser" class="canvi-user-info__meta">æ¯æ—¥æ¥½ã—ããŠã—ã‚ƒã¹ã‚ŠğŸ˜˜</a><br>
                <a id="activePwd" class="canvi-user-info__meta"></a>
            </div>
            <div v-bind:title="msgSwitchTips" class="canvi-user-info__close" onclick="silence()">
                <img id="mute" src="./icon/unmute.png" style="width: 25px;">
            </div>
        </div>
        <ul id="cebian" class="canvi-navigation">
        </ul>
    </aside>

    <main class="js-canvi-content canvi-content"></main>

    <div>
        <button id="btn" style="display: none" class="js-canvi-open-button--left btn">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³äººæ•°ã®è¡¨ç¤º</button>
        <div style="display: none;">
            <div>
                <span>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼š</span>
                <input id="nick" type="text">
            </div>
            <div>
                <span>ã¸ã‚„ï¼š</span>
                <input id="room" type="text">
            </div>
            <div>
                <span>ãƒ¦ãƒ¼ã‚¶IDï¼š</span>
                <input id="userId" type="text">
            </div>
        </div>

        <div id="message" style="display: none"></div>

        <div id="footer" class="footer">
            <div id="toolbar" style="padding: 5px;">
                <img id="emoji" v-bind:title="emojiTips" src="icon/emoji.png" style="width: 26px;margin-left: 10px">
                <img id="sendImg" v-bind:title="pictureTips" onclick="moniSendImg()" src="icon/picture.png" style="width: 23px;margin-left: 10px">
                <img id="shakeMsg" v-bind:title="shakeTips" class="shake-constant shake-constant--hover" onclick="beginShake()" src="icon/shakeFalse.png" style="width: 22px;margin-left: 10px">
                <img id="clear" v-bind:title="clearTips" onclick="emptyScreen()"src="icon/clear.png" style="width: 23px;margin-left: 10px">
                <img id="send" v-bind:title="sendTips" onclick="send()" src="icon/send.png" style="width: 24px;position: absolute;right: 10px">
            </div>
            <div id="text" contenteditable="true"></div>
        </div>

        <form id="imageUp" style="display: none">
            <a href='javascript:void(0);' class="blueButton">ç”»åƒã‚’é€ã‚‹</a>
            <input type="file" class="myFileUpload" name="file" id="image" onchange="sendImg(this)"/>
        </form>
    </div>

    <div class="login" id="window">
        <div class="login-title">éƒ¨å±‹ã«å…¥ã‚‹</div>
        <div class="login-input-content">
            <div class="login-input">
                <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼š</label>
                <input type="text" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"   id="nickname" class="list-input"/>
            </div>
            <div class="login-input">
                <label>ã¸ã‚„ï¼š</label>
                <input type="text" placeholder="éƒ¨å±‹ã«å…¥åŠ›ã—ã¦ãã ã•ã„" onfocus="allRoom(this)"  id="roomname" class="list-input" list="rooms"/>
                <datalist id="rooms"></datalist>
            </div>
            <div class="login-input" style="height: 0px">
                <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼š</label>
                <input type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç©ºç™½ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™" id="password" class="list-input" list="rooms"/>
            </div>
        </div>
        <div class="login-button" onclick="editNick()"><a style="text-decoration:none;color:#ffffff;" href="javascript:void(0);" id="login-button-submit">å…¥ã‚‹</a></div>
    </div>

</body>

<script type="text/javascript">

    window.onfocus = function() {
        focus = false;
    };
    window.onblur = function() {
        focus = true;
    };

    // for IE
    document.onfocusin = function() {
        focus = false;
    };
    document.onfocusout = function() {
        focus = true;
    };

    //ç¾åœ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ãŒWebSocketã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã™ã‚‹
    if('WebSocket' in window){
        websocket = new WebSocket(wsHost);
    }else{
        layer.msg(unSupportWsMsg,{anim: 6})
    }

    //æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹æ³•
    websocket.onerror = function(){
        layer.msg(onerrorMsg,{anim: 6});
    };

    //æ¥ç¶šãŒæ­£å¸¸ã«ç¢ºç«‹ã•ã‚ŒãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹æ³•
    websocket.onopen = function(event){
        self.setInterval("ping()",55000);
    }

    // ãƒœã‚¿ãƒ³ã®ä¸Šã«ãƒã‚¦ã‚¹ã‚’ç½®ã„ãŸã¨ãã«Tipsã‚’é…ã‚‰ã›ã‚‹
    function delayTips(tips,obj,style,time){
        timer = setTimeout(messagebox,time==null?700:time,tips,obj,style)
    }

    // Tipsé…å»¶ã‚¿ã‚¤ãƒãƒ¼ã®åœæ­¢
    function stopTimer(){
        if(timer != null){
            clearTimeout(timer);
            layer.closeAll('tips');
        }
    }

    // Tips
    function messagebox(tips,obj,style){
        layer.tips(tips,obj,style);
    }

    //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹æ³•
    websocket.onmessage = function(event){
        var data = JSON.parse(event.data)
        var msg = data.msg;
        var nick = data.sendUser;
        var shakeStatus = data.shake;
        if (focus && mute%2==0) {
            playSound();
            notifyMe(data);
        }
        switch(data.type){
            case 'init':
                getOnlion(document.getElementById('room').value);
                layer.msg(msg);
                break;
            case 'msg':
                setMessageInnerHTML(nick,text2Emoji2(msg),shakeStatus);
                break;
            case 'img':
                setImgInnerHTML(nick,msg);
                break;
            case 'bing':
                document.getElementById('userId').value = data.id;
                $('body').css("background-image","url("+msg+")");
                break;
            default:
                break;
        }
    }

    //æ¥ç¶šã‚¯ãƒ­ãƒ¼ã‚ºã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯æ–¹æ³•
    websocket.onclose = function(){
        layer.alert(oncloseMsg, {icon: 2});
        $("#footer").animate({bottom:'-200px'},400);

    }

    //ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‚å—ã—ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‹ã¨ã€websocketæ¥ç¶šã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«é–‰ã˜ã€æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¦ã„ãªã„ã†ã¡ã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹ã“ã¨ã‚’é˜²æ­¢ã—ã€serverç«¯ã«ç•°å¸¸ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã¾ã™ã€‚
    window.onbeforeunload = function(){
        websocket.close();
    }

    // ç”»é¢ã‚’ã‚¯ãƒªã‚¢
    function emptyScreen(){
        layer.msg('ç”»é¢ã‚’ç©ºã«ã™ã‚‹ã‹ï¼Ÿ', {
            anim: 6,
            time: 0 //è‡ªå‹•çš„ã«é–‰ã˜ãªã„
            ,btn: ['OK', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«']
            ,yes: function(index){
                layer.close(index);
                $("#message").empty();
            }
        });
    }

    // ã‚¸ãƒƒã‚¿ã‚’åœæ­¢ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    function stopShake(obj) {
        var array = $(obj).attr("class").split(" ")
        $(obj).removeClass(array[3]);
    }

    // åŸå›³ã®è¡¨ç¤º
    function originalImage(obj) {
        layer.photos({
            photos: obj
            ,anim: 5 //0-6ã®é¸æŠã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ”ã‚¯ãƒãƒ£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡ã‚’æŒ‡å®šã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆ3.0ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯shiftãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
        });
    }

    //Webãƒšãƒ¼ã‚¸ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
    function setMessageInnerHTML(nick,msg,shake){
        var a = '<div class="botui-message-left"><div ondblclick="stopShake(this)" class="botui-message-content shake-constant shake-constant--hover';
        if (shake != null || shake != ""){
            a = a + ' '+shake+'">';
        }else {
            a = a + '">';
        }
        $("#message").append("<div class='sendUser'><b>"+nick+"</b></div>"+a+msg+b);
        scrollToEnd();
        $(".botui-message-content").animate({'margin-left':'0px'},200);
    }

    //è‡ªåˆ†ãŒé€ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’Webãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã™ã‚‹
    function setMessageInnerHTML2(nick,msg,shake){
        var c = '<div class="botui-message-right"><div ondblclick="stopShake(this)" class="botui-message-content2 shake-constant shake-constant--hover';
        if (shake != null || shake != ""){
            c = c + ' '+shake+'">';
        }else {
            c = c + '">';
        }
        $("#message").append("<div class='sendUser' style='text-align: right;'><b>"+nick+"</b></div>"+c+msg+b);
        scrollToEnd();
        $(".botui-message-content2").animate({'margin-right':'0px'},200);
    }

    //Webãƒšãƒ¼ã‚¸ã«ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹
    function setImgInnerHTML(nick,msg){
        $("#message").append("<div class='sendUser'><b>"+nick+"</b></div>"+aa+"<img style=\"max-width: -moz-available;\" src='"+msg+"'"+b);
        scrollToEnd();
        $(".botui-message-content-img").animate({'margin-left':'0px'},200);
    }

    //è‡ªåˆ†ãŒé€ã£ãŸç”»åƒã‚’Webãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã™ã‚‹
    function setImgInnerHTML2(nick,msg){
        $("#message").append("<div class='sendUser' style='text-align: right;'><b>"+nick+"</b></div>"+cc+"<img style=\"max-width: -moz-available;\" src='"+msg+"'"+b);
        scrollToEnd();
        $(".botui-message-content2-img").animate({'margin-right':'0px'},200);
    }

    function moniSendImg() {
        document.getElementById("image").click();
    }
    
    //æ¥ç¶šã‚’é–‰ã˜ã‚‹
    function closeWebSocket(){
        websocket.close();
    }
    
    //ã‚¹ã‚¤ãƒƒãƒãƒ³ã‚°ã‚¸ãƒƒã‚¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    function beginShake() {
        if (shakeNum == 8){
            $('#shakeMsg').attr("src","./icon/shakeFalse.png");
            $("#shakeMsg").removeClass(shakeList[shakeNum]);
            layer.msg("ã‚¸ãƒƒã‚¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ");
            shakeNum=0;
        }else {
            $("#shakeMsg").removeClass(shakeList[shakeNum]);
            shakeNum+=1;
            $('#shakeMsg').attr("src","./icon/shakeTrue.png");
            $("#shakeMsg").addClass(shakeList[shakeNum]);
            layer.msg(shakeChinese[shakeNum]);
        }
    }

    //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
    function send(){
        var msgBak = document.getElementById('text').innerHTML;
        var nick = document.getElementById('nick').value;
        // å¤‰æ›emoji
        $($("#text").children(".emoji_icon")).each(function () {
            $(this).prop('outerHTML', textHead+$(this).attr("src").split(emojiPath)[1]+textFoot);
        });
        var msg = document.getElementById('text').innerHTML;
        if (msg != null && msg != ""){
            msg = msg.replace(/"/g,"'");
            var map = new Map();
            map.set("type","msg");
            map.set("msg",msg);
            var shiels = new Array();
            shieldMap.forEach(function (value) {
                shiels.push(value);
            })
            map.set("shiels",shiels);
            map.set("shake",shakeList[shakeNum]);
            var map2json=Map2Json(map);
            if (map2json.length < 8000){
                websocket.send(map2json);
                document.getElementById('text').innerHTML = null;
                setMessageInnerHTML2(nick,text2Emoji2(msg),shakeList[shakeNum]);
            }else {
                $("#text").html(msgBak);
                layer.msg("ãƒ†ã‚­ã‚¹ãƒˆãŒé•·ã™ãã‚‹ã‹ã‚‰ã€å°‘ã—æ›¸ãã¾ã—ã‚‡ã†ã€‚ğŸ˜­",{anim: 6});
            }
        }else {
            layer.msg("ç©ºã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã¨ã¯ã©ã†ã„ã†æ„å‘³ã§ã™ã‹ã€‚ğŸ¤”",{anim: 6});
        }
    }

    //ã‚µãƒ¼ãƒ“ã‚¹å´ãŒnginxã‚’è»¢é€ã™ã‚‹ã¨ã€'proxy _read_timeout'ã®è¨­å®šã¯çŸ­ã™ãã¦è‡ªå‹•çš„ã«åˆ‡æ–­ã•ã‚Œã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯1åˆ†é–“ãªã®ã§ã€ãƒãƒ£ãƒƒãƒˆã—ãªã„çŠ¶æ…‹ã§åˆ‡æ–­ã•ã‚Œãªã„ã‚ˆã†ã«ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆæ¥ç¶šã‚’é€ä¿¡ã—ã¾ã™
    function ping() {
        var map = new Map();
        map.set("type","ping");
        var map2json=Map2Json(map);
        websocket.send(map2json);
    }

    // ãƒ†ã‚­ã‚¹ãƒˆã‚’emojiãƒ”ã‚¯ãƒãƒ£ã«å¤‰æ›
    function text2Emoji2(emojiMsg) {
        return emojiMsg.replace(new RegExp(textHead,"g"),emojiHead).replace(new RegExp(textFoot,"g"),emojiFoot);
    }

    //ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨éƒ¨å±‹ç•ªå·ã‚’é€ä¿¡
    function sendnick(nick,room,pwd){
        var map = new Map();
        map.set("type","init");
        map.set("nick",nick);
        map.set("room",room);
        map.set("pwd",pwd);
        var message = Map2Json(map);
        websocket.send(message);
        document.getElementById('text').innerHTML = null;
        document.getElementById('activeRoom').innerText = 'ã¸ã‚„ï¼š'+room;
        document.getElementById('activeUser').innerText = 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼š'+nick;
        if (pwd != null && pwd != ""){
            document.getElementById('activePwd').innerText = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼š'+pwd;
        }else {
            $("#activePwd").css('display','none');
        }
        $('#btn').trigger("click");
        getOnlion(document.getElementById('room').value);
        $('body').css("background-image","none");
        $("#window").animate({top:'-100%'},500);
        $("#footer").animate({bottom:'0px'},400);
        $("#message").show();
        layer.alert(firstTips);
        //ã“ã®æ–¹æ³•ã¯è¿‘ã„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒˆãƒ³ã‚’å¼•ãèµ·ã“ã™ã®ã§ã€ã—ã°ã‚‰ããŠã¨ãªã—ãã•ã›ã¦ãŠãã¾ã™
        setTimeout(function(){ loadEmoji(); }, 500);
    }

    // è¡¨æƒ…ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€ã“ã®æ–¹æ³•ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ã€è‚‰çœ¼ã§è¦‹ãˆã‚‹ã‚«ãƒ¼ãƒˆãƒ³ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
    function loadEmoji() {
        $("#text").emoji({
            button: "#emoji",
            showTab: true,
            animation: 'slide',
            icons: [{
                name: "QQè¡¨æƒ…",
                path: "dist/img/qq/",
                maxNum: 154,
                file: ".gif"

            },{
                name: "è²¼ã‚Šä»˜ã‘ã‚‰ã‚ŒãŸè¡¨æƒ…",
                path: "dist/img/tieba/",
                maxNum: 50,
                file: ".jpg"
            },{
                name: "dog",
                path: "dist/img/dog/",
                maxNum: 37,
                file: ".png"
            },{
                name: "æ‚ªã„",
                path: "dist/img/huai/",
                maxNum: 189,
                file: ".png"
            },{
                name: "æ‚ªã„GIF",
                path: "dist/img/huaiGif/",
                maxNum: 26,
                file: ".gif"
            },{
                name: "ãƒã‚¤ã‚¯ãƒ­ãƒ–ãƒ­ã‚°",
                path: "dist/img/weibo/",
                maxNum: 93,
                file: ".png"
            },{
                name: "å‘çŒ¥ãªèŒãˆ",
                path: "dist/img/xiaoren/",
                maxNum: 186,
                file: ".gif"
            }]
        });
    }

    //ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚­ãƒ¼
    $(document).keydown(function(e) {
        // Enterã‚­ãƒ¼ã«ã‚ˆã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡
        if (e.keyCode == 13) {
            var topValue = $("#window").css('top');
            var topPx = topValue.substring(0,topValue.length-2);
            if (topPx > 0){
                editNick();
            }else {
                send();
                return false;
            }
        }else if(e.keyCode == 27){ //ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚­ãƒ¼
            $('#shakeMsg').attr("src","./icon/shakeFalse.png");
            $("#shakeMsg").removeClass(shakeList[shakeNum]);
            shakeNum=0;
            layer.msg("ã‚¸ãƒƒã‚¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ");
        }
    });

    //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸã‚‰è‡ªå‹•çš„ã«ä¸‹ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    function scrollToEnd(){
        var h = $("html,body").height()-$(window).height();
        $("html,body").animate({scrollTop:h},200);
    }

    //éƒ¨å±‹ç•ªå·ã¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’è¨­å®šã—ã¦é€ä¿¡ã—ã€'#btn'ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã—ã¾ã™
    function editNick() {
        var nickname = $("#nickname").val();
        var roomname = $("#roomname").val();
        var password = $("#password").val();
        document.getElementById('nick').value = nickname;
        document.getElementById('room').value = roomname;
        if (nickname == "" || roomname == ""){
            layer.msg("éƒ¨å±‹ç•ªå·ã¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯ç©ºç™½ã«ã§ãã¾ã›ã‚“ï¼",{anim: 6});
            return;
        }
        $.ajax({
            type: "POST",
            url: "/ws/judgeNick",
            data: {room:roomname,nick:nickname,pwd:password},
            dataType: "json",
            success: function(data){
                //éƒ¨å±‹ã¯å­˜åœ¨ã™ã‚‹ãŒãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯é‡è¤‡ã™ã‚‹
                if (data.code == 1){
                    layer.msg(data.msg,{anim: 6});
                    document.getElementById('nickname').value = '';
                    return;
                }else if (data.code == 2){ //éƒ¨å±‹ã¯å­˜åœ¨ã™ã‚‹ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã‚‹
                    if (password == null || password == ""){
                        if ($(".login").css("height") == "300px"){
                            layer.msg("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",{anim: 6});
                        }else {
                            ejectPwd("ã“ã®éƒ¨å±‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™");
                        }
                    }else {
                        layer.msg(data.msg,{anim: 6});
                        document.getElementById('password').value = "";
                    }
                    return;
                }else if (data.code == 0){
                    //éƒ¨å±‹ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚’ç¤ºã™
                    if (password == null || password == ""){
                        layer.confirm('ã“ã®éƒ¨å±‹ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã‹ã€‚ï¼Ÿ', {
                            btn: ['å¿…è¦','ã„ã„ãˆ'] //ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
                        }, function(){
                            ejectPwd("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                            layer.closeAll('dialog');
                        }, function(){
                            sendnick(nickname,roomname,password);
                        });
                    }else {
                        sendnick(nickname,roomname,password);
                    }
                }else {
                    sendnick(nickname,roomname,password);
                }
            }
        });
    }


    //ç¾åœ¨ã®éƒ¨å±‹ã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
    function getOnlion(room) {
        $.ajax({
            type: "POST",
            url: "/ws/online",
            data: {room:room},
            dataType: "json",
            success: function(data){
                if (data.onlineNum > 0){
                    var onlineUsera = data.onlineUsera;
                    $("#cebian").html("");
                    onlineUsera.forEach(function (user) {
                        var color = "#00ce46";
                        if (shieldMap.has("user-"+user.id)){
                            color = "#FF3A43"
                        }
                        if (user.id != $("#userId").val()){
                            var html = '<li>\n' +
                                '                <a class="canvi-navigation__item">\n' +
                                '                    <span title="è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ã«ã¯ã€ã“ã®äººã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„" id="user-'+user.id+'" class="canvi-navigation__icon-wrapper" onclick="shield(this)" style="background: '+color+';">\n' +
                                '                        <span class="canvi-navigation__icon icon-iconmonstr-code-13"></span>\n' +
                                '                    </span>\n' +
                                '                    <span class="canvi-navigation__text">'+user.nick+'</span>\n' +
                                '                </a>\n' +
                                '            </li>';
                            $("#cebian").append(html);
                        }
                    });
                }
            }
        });
    }

    // ãƒ¡ãƒ³ãƒãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ç§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã•ã›ãªã„
    function shield(obj) {
        var userId = obj.id.substring(5)
        if (userId != $("#userId").val()){
            if (shieldMap.has(obj.id)){
                shieldMap.delete(obj.id);
                layer.msg('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†å—ä¿¡ã—ã¾ã™ğŸ˜');
            }else {
                shieldMap.set(obj.id,userId);
                layer.msg('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¾ã›ã‚“ğŸ˜‰');
            }
            getOnlion(document.getElementById('room').value);
        }else {
            layer.msg('ã“ã‚Œã¯ã‚ãªãŸè‡ªèº«ã§ã™ã‚ˆã€æ³¨æ–‡ã—ã¦ã‚‚ç„¡é§„ã§ã™ğŸ˜‚');
        }
    }

    //ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆéŸ³ã‚’å†ç”Ÿ
    function playSound(){
        var borswer = window.navigator.userAgent.toLowerCase();
        if ( borswer.indexOf( "ie" ) >= 0 )
        {
            //IEã‚«ãƒ¼ãƒãƒ«ãƒ–ãƒ©ã‚¦ã‚¶
            var strEmbed = '<embed name="embedPlay" src="./audio/ding.mp3" autostart="true" hidden="true" loop="false"></embed>';
            if ( $( "body" ).find( "embed" ).length <= 0 )
                $( "body" ).append( strEmbed );
            var embed = document.embedPlay;

            //ãƒ–ãƒ©ã‚¦ã‚¶ãŒaudionã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å ´åˆã¯ã€embedã‚’ä½¿ç”¨ã—ã¦å†ç”Ÿã—ã¾ã™
            embed.volume = 100;
            //embed.play();
        } else
        {
            //IEä»¥å¤–ã®ã‚«ãƒ¼ãƒãƒ«ãƒ–ãƒ©ã‚¦ã‚¶
            var strAudio = "<audio id='audioPlay' src='./audio/ding.mp3' hidden='true'>";
            if ( $( "body" ).find( "audio" ).length <= 0 )
                $( "body" ).append( strAudio );
            var audio = document.getElementById( "audioPlay" );

            //ãƒ–ãƒ©ã‚¦ã‚¶ã¯audionã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™
            audio.play();
        }
    }


    var t = new Canvi({
        content: ".js-canvi-content",
        isDebug: !1,
        navbar: ".myCanvasNav",
        openButton: ".js-canvi-open-button--left",
        position: "left",
        pushContent: !1,
        speed: "0.2s",
        width: "100vw",
        responsiveWidths: [ {
            breakpoint: "600px",
            width: "21%"
        }, {
            breakpoint: "1280px",
            width: "21%"
        }, {
            breakpoint: "1600px",
            width: "21%"
        } ]
    })


    function sendImg(obj) {
        var file = document.getElementById("imageUp");
        var image = document.getElementById("image");
        if (!(image.value == null || image.value == "")){
            var img = getObjectURL(obj.files[0]);
            var nick = document.getElementById('nick').value;
            setImgInnerHTML2(nick,img);
            var form = new FormData(file);
            loadImage(image,1024);
            upImgByLocalApi(form);
            // form.append("type","multipart");
            // loadImage(image,10240);
            // setTimeout(function(){ upImgByFigureBed(form); }, 300);
            image.value = null;
        }
    }

    function getObjectURL(file) {
        var url = null;
        if (window.createObjcectURL != undefined) {
            url = window.createOjcectURL(file);
        } else if (window.URL != undefined) {
            url = window.URL.createObjectURL(file);
        } else if (window.webkitURL != undefined) {
            url = window.webkitURL.createObjectURL(file);
        }
        return url;
    }

    //å›³åºŠã‚’ä½¿ç”¨ã—ãŸç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    function upImgByFigureBed(form) {
        // var url;
        $.ajax({
            url: "http://api.yum6.cn/sinaimg.php",
            type: "POST",
            data: form,
            async:false,
            processData:false,
            contentType:false,
            success: function (data) {
                var url =  data.url.replace("thumb150","large");
                if (url != null && url != ""){
                    var map = new Map();
                    map.set("type","img");
                    map.set("msg",url);
                    var shiels = new Array();
                    shieldMap.forEach(function (value) {
                        shiels.push(value);
                    })
                    map.set("shiels",shiels);
                    var map2json=Map2Json(map);
                    websocket.send(map2json);
                }
            },
            error: function (data) {
                layer.msg("å¤±è´¥",{anim: 6});
            }
        });
    }

    //ã‚·ã‚¹ãƒ†ãƒ è‡ªä½“ã®ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ãŸç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    function upImgByLocalApi(form) {
        $.ajax({
            url: "/ws/fileUpload",
            type: "POST",
            data: form,
            async:false,
            processData:false,
            contentType:false,
            success: function (data) {
                var url = data.url;
                if (url != null && url != ""){
                    var map = new Map();
                    map.set("type","img");
                    map.set("msg",url);
                    var shiels = new Array();
                    shieldMap.forEach(function (value) {
                        shiels.push(value);
                    })
                    map.set("shiels",shiels);
                    var map2json=Map2Json(map);
                    websocket.send(map2json);
                }
            },
            error: function (data) {
                layer.msg("å¤±è´¥",{anim: 6});
            }
        });
    }

    function Map2Json(map) {
        var str = "{";
        map.forEach(function (value, key) {
            str += '"'+key+'"'+':'+ '"'+value+'",';
        })
        str = str.substring(0,str.length-1)
        str +="}";
        return str;
    }

    //ç”»åƒã®ç¨®é¡ã¨ã‚µã‚¤ã‚ºã‚’æ¤œè¨¼ã™ã‚‹
    function loadImage(img,size) {
        var filePath = img.value;
        var fileExt = filePath.substring(filePath.lastIndexOf("."))
            .toLowerCase();

        if (!checkFileExt(fileExt)) {
            layer.msg("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ç”»åƒã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼",{anim: 6});
            img.value = "";
            return;
        }
        if (img.files && img.files[0]) {
            if ((img.files[0].size / 1024).toFixed(0) > size){
                layer.msg("ç”»åƒã¯1 Mã‚’è¶…ãˆã¦ã¯ã„ã‘ã¾ã›ã‚“ã®ã§ã€ã‚‚ã†ä¸€åº¦é¸æŠã—ã¦ãã ã•ã„",{anim: 6});
                img.value = "";
                return;
            }
        } else {
            img.select();
            var url = document.selection.createRange().text;
            try {
                var fso = new ActiveXObject("Scripting.FileSystemObject");
            } catch (e) {
                layer.msg('ie 8ä»¥ä¸‹ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ã‚’ä¸‹ã’ã¦ãã ã•ã„ï¼',{anim: 6});
            }
            layer.msg("ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯ï¼š" + (fso.GetFile(url).size / 1024).toFixed(0) + "kb",{anim: 6});
        }
    }

    function checkFileExt(ext) {
        if (!ext.match(/.jpg|.jpeg|.gif|.png|.bmp/i)) {
            return false;
        }
        return true;
    }

    function notifyMe(data) {
        var notification = null;
        var msg = data.msg;
        var nick = data.sendUser;
        var type = data.type;
        switch(type){
            case 'init':
                notification = new Notification(nick,{
                    body: msg,
                    icon: 'http://'+host+'/icon/enter.png',
                });
                break;
            case 'msg':
                notification = new Notification(nick,{
                    body: msg,
                    icon: 'http://'+host+'/icon/mail.png',
                });
                break;
            case 'img':
                notification = new Notification(nick,{
                    icon: msg,
                    // body: 'ç”»åƒã‚’å—ã‘å–ã‚Šã¾ã—ãŸ',
                });
                break;
            default:
                break;
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰
        if (!("Notification" in window)) {
            layer.msg("ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“",{anim: 6});
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€šçŸ¥ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã«åŒæ„ã™ã‚‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        else if (Notification.permission === "granted") {
            // If it's okay let's create a notification
            var notification1 = notification;
            notification.onclick = function() {
                notification.close();
                window.resizeBy(-100,-100)
            };
        }

        // ãã†ã§ãªã‘ã‚Œã°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ¨©é™ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
        else if (Notification.permission !== 'denied') {
            Notification.requestPermission(function (permission) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ„ã™ã‚Œã°ã€é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™
                if (permission === "granted") {
                    var notification1 = notification;
                    notification.onclick = function() {
                        notification.close();
                        window.resizeBy(-100,-100)
                    };
                }
            });
        }
        // æœ€å¾Œã«ã€ã“ã“ã¾ã§å®Ÿè¡Œã™ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é–¢é€£é€šçŸ¥ã®è¨±å¯ã‚’æ‹’å¦ã—ã¾ã—ãŸ
        // å°Šé‡ã®ãŸã‚ã«ã€ç§ãŸã¡ã¯å½¼ã‚‰ã‚’é‚ªé­”ã™ã‚‹ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“
    }

    function checkNotification() {
        $(".login").animate({height:'250px'},200);
        $(".login-input-content").animate({'margin-top':'0px'},200);
        if (!("Notification" in window)) {
            layer.msg("ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“",{anim: 6});
        }else{
            Notification.requestPermission();
        }
    }
    
    function allRoom(obj){
        $.ajax({
            type: "POST",
            url: "/ws/allRoom",
            dataType: "json",
            success: function(data){
                var rooms = data.rooms;
                $("#rooms").empty();
                if (rooms.length > 0){
                    layer.tips("æ—¢å­˜ã®éƒ¨å±‹ã‚’é¸æŠã™ã‚‹ã«ã¯ã€ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒã‚¤ãƒ³ãƒˆ",obj);
                }
                rooms.forEach(function (room) {
                    var html = '<option value="'+room+'">';
                    $("#rooms").append(html);
                });

            }
        });
    }
    
    function silence() {
        mute++;
        if (mute%2 == 0){
            $('#mute').attr("src","./icon/unmute.png");
            layer.msg("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥ãŒã‚ªãƒ¼ãƒ—ãƒ³ã—ã¾ã—ãŸ");
        }else {
            $('#mute').attr("src","./icon/mute.png");
            layer.msg("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€šçŸ¥ãŒçµ‚äº†ã—ã¾ã—ãŸ");
        }
    }

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
    function ejectPwd(message) {
        $(".login-input").animate({height:'35px'},300);
        $(".login").animate({height:'300px'},300);
        $("#password").attr('placeholder',message);
    }

    new Vue({
            el: '#toolbar',
            data: {
                emojiTips : emojiTips,
                pictureTips : pictureTips,
                shakeTips : shakeTips,
                clearTips : clearTips,
                sendTips : sendTips,
            }
        })

    new Vue({
        el: '#canvi',
        data: {
            msgSwitchTips : msgSwitchTips
        }
    })

</script>
</html>